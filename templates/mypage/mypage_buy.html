{% extends "index.html" %} 
{% block head %} 
{{ super() }}
    <link rel="stylesheet"  href="{{ url_for('static', filename='mypage1_1.css') }}">
{% endblock head %} 

{% block section %}
<main class="purchase-history">
    <h2><span class="user-name">{{ user_name }}</span> 님의 구매 내역</h2>

    {% if total > 0 %}
    <!-- 구매 내역 카드 리스트 -->
    <div class="purchase-list">

        {% for order_id, order in row1 %}
        <div class="purchase-card
            {% if order.is_deleted %} deleted{% endif %}"
            onclick="handleOrderClick('{{ 'Y' if order.is_deleted else 'N' }}',
                               '{{ url_for('view_item_detail', item_id=order.productID) }}')"
            style="cursor: pointer;">
            
            <div class="item-image">
                {% set img = order.item_img[0] if order.item_img is sequence and order.item_img is not string else order.item_img %}
                
                {% if img %}
                    <img src="{{ url_for('static', filename='images/' + img) }}" 
                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                {% else %}
                    <div style="background-color: #f0f0f0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #888;">No Image</div>
                {% endif %}
            </div>

            <div class="item-content">
                <div class="item-info">
                    <p class="seller">판매자: {{ order.sellerID }}</p>
                    <p class="item-name">{{ order.item_name }}
                        {% if order.is_deleted %}
                            <span class="deleted-tag">(판매 종료)</span>
                        {% endif %}
                    </p>
                    <p class="item-price">{{ order.item_price }}원</p>
                </div>
                {% if order.is_deleted %}
                    <!-- 상품 삭제된 경우: 리뷰 버튼 비활성화 -->
                    <button type="button"
                            class="review-btn review-btn--disabled"
                            disabled
                            onclick="event.stopPropagation();">
                        리뷰 작성 불가
                    </button>
                {% else %}
                    <button type="button" 
                            onclick="event.stopPropagation(); 
                            location.href='{{ url_for('reg_review_init', item_id=order.productID) }}'" 
                            class="review-btn">
                        리뷰 작성
                    </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>    

    {% else %}
    <p>구매한 상품이 없습니다.</p>
    {% endif %}

    <!-- 페이지네이션 -->
    <nav class="pagination">

        <!-- 이전 페이지 버튼 -->
        {% if page > 0 %}
        <a class="page-btn" href="{{ url_for('mypage_buy', page=page-1) }}">&lsaquo;</a>
        {% else %}
        <span class="page-btn" style="opacity:0.4; pointer-events:none;">&lsaquo;</span>
        {% endif %}

        <!-- 페이지 번호 반복 -->
        {% for i in range(page_count) %}
        <a class="page-number {% if i == page %}active{% endif %}" 
            href="{{ url_for('mypage_buy', page=i) }}">
            {{ i + 1 }}
        </a>
        {% endfor %}

        <!-- 다음 페이지 버튼 -->
        {% if page < page_count - 1 %}
        <a class="page-btn" href="{{ url_for('mypage_buy', page=page+1) }}">&rsaquo;</a>
        {% else %}
        <span class="page-btn" style="opacity:0.4; pointer-events:none;">&rsaquo;</span>
        {% endif %}

    </nav>

</main>

<script>
    function handleOrderClick(isDeleted, detailUrl) {
    if (isDeleted === 'Y') {
      alert('이 상품은 이미 삭제된 상품입니다!');
      return;
    }
    window.location.href = detailUrl;
  }
</script>


{% endblock section %}