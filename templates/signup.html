<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../static/style.css" />
    <link rel="stylesheet" type="text/css" href="../static/auth_style.css" />
  </head>

  <body>
    {% block section %} {% with mesg = get_flashed_messages() %} {% if mesg !=
    [] %}
    <script>
      alert("{{ mesg[0] }}");
    </script>
    {% endif %} {% endwith %}
    <div class="signup-out">
      <h1 class="logo-auth">CoRise</h1>
      <form method="post" action="/signup_post">
        <div class="signup-in">
          <div>
            <label>아이디<span>*</span></label>
            <input
              type="text"
              name="id"
              placeholder="아이디를 입력해 주세요"
              required
            />
            <button type="button" class="signup-check-btn" onclick="checkId()">
              중복확인
            </button>
          </div>
          <br />
          <div>
            <label>닉네임<span>*</span></label>
            <input
              type="text"
              name="nickname"
              placeholder="닉네임을 입력해 주세요"
              required
            />
            <button type="button" class="signup-check-btn" onclick="checkNickname()">중복확인</button>
          </div>
          <br />
          <div>
            <label>비밀번호<span>*</span></label>
            <input
              type="password"
              name="pw"
              placeholder="비밀번호를 입력해 주세요"
              required
            />
          </div>
          <br />
          <div>
            <label>비밀번호 확인<span>*</span></label>
            <input
              type="password"
              name="pw_confirm"
              placeholder="비밀번호를 다시 입력해 주세요"
              required
            />
          </div>
          <br />
          <div>
            <label>이메일 주소<span>*</span></label>
            <input
              type="email"
              name="email"
              placeholder="이메일을 입력해 주세요"
              required
            />
          </div>
          <br />
          <div>
            <label>전화번호</label>
            <input type="tel" name="phone" />
          </div>
          <br />
          <div>
            <input type="submit" id="signup-btn" value="가입하기" /><b></b>
          </div>
        </div>
      </form>
    </div>

    {% endblock section %}
    
  <script>
    let idChecked = false;
    let nicknameChecked = false;

    // 아이디 중복 확인
    function checkId() {
      const idInput = document.querySelector('input[name="id"]');
      const userId = idInput.value.trim();

      if (!userId) {
        alert("아이디를 입력해 주세요.");
        idInput.focus();
        return;
      }

      fetch("/check_id?id=" + encodeURIComponent(userId))
        .then((res) => res.json())
        .then((data) => {
          // data = { ok: True, available: True/False, message: "..." }
          if (!data.ok) {
            alert("오류가 발생했습니다.");
            idChecked = false;
            return;
          }

          alert(data.message);

          if (data.available) {
            // 사용 가능
            idChecked = true;
          } else {
            // 이미 사용 중
            idChecked = false;
            idInput.focus();
          }
        })
        .catch((err) => {
          console.error(err);
          alert("서버 오류가 발생했습니다.");
          idChecked = false;
        });
    }

    // 닉네임 중복 확인
    function checkNickname() {
      const nickInput = document.querySelector('input[name="nickname"]');
      const nickname = nickInput.value.trim();

      if (!nickname) {
        alert("닉네임을 입력해 주세요.");
        nickInput.focus();
        return;
      }

      fetch("/check_nickname?nickname=" + encodeURIComponent(nickname))
        .then((res) => res.json())
        .then((data) => {
          if (!data.ok) {
            alert("오류가 발생했습니다.");
            nicknameChecked = false;
            return;
          }

          alert(data.message);

          if (data.available) {
            nicknameChecked = true;
          } else {
            nicknameChecked = false;
            nickInput.focus();
          }
        })
        .catch((err) => {
          console.error(err);
          alert("서버 오류가 발생했습니다.");
          nicknameChecked = false;
        });
    }

    // 아이디/닉네임 수정하면 다시 체크하게 flag 초기화
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("form");
      const idInput = form.querySelector('input[name="id"]');
      const nickInput = form.querySelector('input[name="nickname"]');

      idInput.addEventListener("input", () => { idChecked = false; });
      nickInput.addEventListener("input", () => { nicknameChecked = false; });

      // 비밀번호 확인 + 중복확인 안 했으면 submit 막기
      form.addEventListener("submit", (e) => {
        const pw  = form.querySelector('input[name="pw"]').value;
        const pw2 = form.querySelector('input[name="pw_confirm"]').value;

        if (pw !== pw2) {
          e.preventDefault();
          alert("비밀번호가 일치하지 않습니다.");
          form.querySelector('input[name=\"pw_confirm\"]').focus();
          return;
        }

        if (!idChecked || !nicknameChecked) {
          e.preventDefault();
          alert("아이디와 닉네임 중복 확인을 해 주세요.");
          return;
        }
      });
    });
  </script>
  </body>
</html>
