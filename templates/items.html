{% extends "index.html" %} 
{% block head %} 
{{ super() }}
<link rel="stylesheet"  href="{{ url_for('static', filename='item_style.css') }}">
{% endblock head %} 

{% block section %}
<script>
  $(document).ready(function() {
    // Flask에서 전달받은 현재 값들을 Select 박스에 반영하여 상태 유지
    $('#category').val('{{ category }}'); 
    $('select[name="sort"]').val('{{ sort }}');
    $('#search-query').val('{{ search_query or "" }}');

    // 필터 섹션의 select 요소들에 change 이벤트 리스너 추가(활성화 및 수정)
    // 기존 onchange="location=this.value"를 제거하고, 이 JS 로직으로 통합 처리
    $('.filters select').on('change', function() {
      submitFilters();
    });

    $('#search-query').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault(); // 기본 form submit 방지
            submitFilters();
        }
    });

    function submitFilters() {
      // 선택된 값들을 가져옴 
      const category = $('select[name="category"]').val();
      const sort = $('select[name="sort"]').val();
      const search_query = $('#search-query').val().trim();

      // 현재 페이지 URL을 기반으로 쿼리 매개변수 객체 생성
      let queryParams = new URLSearchParams(window.location.search);
      // 필터/정렬 변경 시 페이지를 0으로 리셋
      queryParams.set('page', 0);
      
      if (category && category !== 'all') { 
          queryParams.set('category', category);
      } else {
          queryParams.delete('category');
      }

      if (sort && sort !== 'latest') { 
          queryParams.set('sort', sort);
      } else {
          queryParams.delete('sort');
      }

      if (search_query) { 
          queryParams.set('q', search_query);
      } else {
          queryParams.delete('q');
      }
      
      // 쿼리 파라미터 적용하여 페이지 새로고침
      window.location.search = queryParams.toString();
    }
  });

    function toggleLike(itemId, element) {
        // 로그인 여부 확인(세션 정보가 없으면 알림)
        {% if not session['id'] %}
            alert("로그인이 필요한 기능입니다.");
            location.href = "{{ url_for('login') }}";
            return;
        {% endif %}

        // 현재 아이콘 상태 확인 (채워진 하트인지 아닌지)
        let icon = $(element);

        // 상태는 색상 기준 (빨강이면 찜한 상태)
        let isLiked = icon.css('color') === 'rgb(255, 0, 0)';
        
        // 요청 보낼 URL 결정 (좋아요 상태면 unlike, 아니면 like)
        let url = isLiked ? '/unlike/' + itemId + '/' : '/like/' + itemId + '/';
        
        // AJAX 요청 전송
        $.ajax({
            type: 'POST',
            url: url,
            data: {
              interested: isLiked ? "N" : "Y"
            },
            success: function (response) {
                // 성공 시 아이콘 스타일 토글 (새로고침 없이 즉시 반영)
                if (isLiked) {
                    // 찜 취소: 빨강 -> 회색
                    icon.css('color', 'grey');
                } else {
                    // 찜 하기: 회색 -> 빨강
                    icon.css('color', 'red');
                }
            },
            error: function(error) {
                alert("오류가 발생했습니다. 다시 시도해주세요.");
            }
        });
    }
</script>

<div class="container">
    <!-- 필터 영역 -->
    <section class="filters">
      <!-- 검색창: 시안처럼 길게, 왼쪽 정렬 -->
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 25 24" fill="none" aria-hidden="true">
          <path d="M20.4167 21L13.8542 14.7C13.3333 15.1 12.7344 15.4167 12.0573 15.65C11.3802 15.8833 10.6597 16 9.89583 16C8.00347 16 6.40191 15.3708 5.09115 14.1125C3.78038 12.8542 3.125 11.3167 3.125 9.5C3.125 7.68333 3.78038 6.14583 5.09115 4.8875C6.40191 3.62917 8.00347 3 9.89583 3C11.7882 3 13.3898 3.62917 14.7005 4.8875C16.0113 6.14583 16.6667 7.68333 16.6667 9.5C16.6667 10.2333 16.5451 10.925 16.3021 11.575C16.059 12.225 15.7292 12.8 15.3125 13.3L21.875 19.6L20.4167 21ZM9.89583 14C11.1979 14 12.3047 13.5625 13.2161 12.6875C14.1276 11.8125 14.5833 10.75 14.5833 9.5C14.5833 8.25 14.1276 7.1875 13.2161 6.3125C12.3047 5.4375 11.1979 5 9.89583 5C8.59375 5 7.48698 5.4375 6.57552 6.3125C5.66406 7.1875 5.20833 8.25 5.20833 9.5C5.20833 10.75 5.66406 11.8125 6.57552 12.6875C7.48698 13.5625 8.59375 14 9.89583 14Z" fill="#1D1B20"/>
        </svg>
        <input type="text" placeholder="상품명 검색" name="q" id="search-query" value="{{ search_query or '' }}"/>
      </div>

        <!-- 카테고리 -->
      <label class="select-pill">
        <select id="category" name="category" aria-label="카테고리">
          <option value="all">카테고리</option>
          <option value="가전">가전</option>
          <option value="의류">의류</option>
          <option value="생활">생활</option>
          <option value="도서">도서</option>
          <option value="기타">기타</option>
        </select>
        <svg class="chev" width="22" height="16" viewBox="0 0 28 19" fill="none">
          <path d="M13.2826 18.1387C13.4826 18.4042 13.8813 18.404 14.0814 18.1387L26.7621 1.30078C27.0102 0.97129 26.7751 0.5 26.3627 0.5H1.00134C0.589257 0.500359 0.354175 0.971424 0.601929 1.30078L13.2826 18.1387Z" fill="#FBFAF4" stroke="black"/>
        </svg>
      </label>

      <!-- 정렬 필터 통합 -->
      <label class="select-pill">
        <select name="sort" id="sort-order" aria-label="정렬">
          <option value="latest">최신순</option>
          <option value="popular">인기순</option>
          <option value="low">낮은 가격 순</option>
          <option value="high">높은 가격 순</option>
        </select>
        <svg class="chev" width="22" height="16" viewBox="0 0 28 19" fill="none" aria-hidden="true">
          <path d="M13.2826 18.1387C13.4826 18.4042 13.8813 18.404 14.0814 18.1387L26.7621 1.30078C27.0102 0.97129 26.7751 0.5 26.3627 0.5H1.00134C0.589257 0.500359 0.354175 0.971424 0.601929 1.30078L13.2826 18.1387Z" fill="#FBFAF4" stroke="black"/>
        </svg>
      </label>
    </section>

  {% if total > 0 %}
  <main class="product-grid">

    <!-- Row 1 상품명 부분 변경 -->
    {% for key, value in row1 %}
    <article class="product-card" onclick="location.href='/view_detail/{{ key }}/';" style="cursor: pointer;">
      <div class="hm-thumb">
        {% set img = value.img_path[0] if value.img_path is sequence and value.img_path is not string else value.img_path %}
        <img src="{{ url_for('static', filename='images/' + img) }}" width="140" height="200" alt="{{ value.name }}">
      </div>

      <div class="info">
        <div class="text">
          <p class="product-name">{{ value.name }}</p>
          <p class="price">{{ value.price }}원</p>
        </div>

        <div class="heart-container">
          {% if session['id'] %}
            {% if key in user_likes %}
              <i class="fa fa-heart" style="color: red; cursor: pointer; font-size: 24px;" onclick="toggleLike('{{ key }}', this); event.stopPropagation();"></i>
            {% else %}
              <i class="fa fa-heart" style="color: grey; cursor: pointer; font-size: 24px;" onclick="toggleLike('{{ key }}', this); event.stopPropagation();"></i>
            {% endif %}
          {% else %}
            <i class="fa fa-heart" style="color: grey; font-size: 24px;"></i>
          {% endif %}
        </div>
      </div>
    </article>
    {% endfor %}

    <!-- Row 2 상품명 부분 변경 -->
    {% for key, value in row2 %}
    <article class="product-card" onclick="location.href='/view_detail/{{ key }}/';" style="cursor: pointer;">
      <div class="hm-thumb">
         {% set img = value.img_path[0] if value.img_path is sequence and value.img_path is not string else value.img_path %}
        
        <img src="{{ url_for('static', filename='images/' + img) }}" width="140" height="200" alt="{{ value.name }}">
      </div>
      <div class="info">
        <div class="text">
          <p class="product-name">{{ value.name }}</p>
          <p class="price">{{ value.price }}원</p>
        </div>
        <div class="heart-container">
          {% if session['id'] %}
            {% if key in user_likes %}
              <i class="fa fa-heart" style="color: red; cursor: pointer; font-size: 24px;" onclick="toggleLike('{{ key }}', this); event.stopPropagation();"></i>
            {% else %}
              <i class="fa fa-heart" style="color: grey; cursor: pointer; font-size: 24px;" onclick="toggleLike('{{ key }}', this); event.stopPropagation();"></i>
            {% endif %}
          {% else %}
            <i class="fa fa-heart" style="color: grey; font-size: 24px;"></i>
          {% endif %}
        </div>
      </div>
    </article>
    {% endfor %}
  </main>

    <!-- 페이지네이션 -->
    <nav class="pagination">

      <!-- 이전 페이지 버튼 -->
      {% if page > 0 %}
        <a class="page-btn"
          href="{{ url_for('view_list',
                     page=page-1,
                     category=category,
                     sort=sort,
                     q=search_query) }}">&lsaquo;</a>
      {% else %}
        <span class="page-btn" style="opacity:0.4; pointer-events:none;">&lsaquo;</span>
      {% endif %}

      <!-- 페이지 번호 반복 -->
      {% for i in range(page_count) %}
        <a class="page-number {% if i == page %}active{% endif %}" 
          href="{{ url_for('view_list',
                     page=i,
                     category=category,
                     sort=sort,
                     q=search_query) }}">
          {{ i + 1 }}
        </a>
      {% endfor %}

      <!-- 다음 페이지 버튼 -->
      {% if page < page_count - 1 %}
        <a class="page-btn"
          href="{{ url_for('view_list',
                     page=page+1,
                     category=category,
                     sort=sort,
                     q=search_query) }}">&rsaquo;</a>
      {% else %}
        <span class="page-btn" style="opacity:0.4; pointer-events:none;">&rsaquo;</span>
      {% endif %}

    </nav>


  {% else %}
    <div style="text-align: center; margin-top: 50px; color: #666;">
      <p style="font-size: 18px;">등록된 상품이 없습니다.</p>
    </div>
  {% endif %}


  </div>
{% endblock section %}