{% extends "index.html" %} {% block head %} {{ super() }}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='review_style.css') }}"
/>
{% endblock head %} {% block section %}
<h1 class="rvreg-h1">리뷰 작성</h1>

<section class="rvreg-page">
  <section class="rvreg-product-box">
    <div class="rvreg-product-left">
      <p class="rvreg-product-name">상품 : {{ name }}</p>
      
      <p class="rvreg-ask">이 상품 어때요?</p>
      <div class="rvreg-stars" data-rating="0">
        <span class="star" data-value="1">★</span>
        <span class="star" data-value="2">★</span>
        <span class="star" data-value="3">★</span>
        <span class="star" data-value="4">★</span>
        <span class="star" data-value="5">★</span>
      </div>
      
    </div>
    <div class="rvreg-media" aria-label="상품 이미지 자리">
      {% if product_img %}
      <img
        src="{{ url_for('static', filename='images/' + product_img) }}"
        alt="{{ name }}"
        class="rvreg-media-img"
      >
      {% endif %}
    </div>
  </section>

  <form
    action="/reg_review"
    method="post"
    enctype="multipart/form-data"
    class="reg-review-form"
  >
    <input type="hidden" name="productID" value="{{ item_id }}" />
    <input type="hidden" name="rating" id="rating-input" value="0" />

    <div>
      <label class="rvreg-label" for="title">리뷰 제목</label>
      <input type="text" id="title" name="title" />
    </div>

    <div>
      <label class="rvreg-label" for="content">리뷰 내용</label>
      <textarea
        id="content"
        name="content"
        rows="6"
        placeholder="구매하신 상품 후기를 남겨 주시면 다른 구매자분들께 큰 도움이 됩니다."
      ></textarea>
    </div>

    <div>
      <label class="rvreg-label" for="photos">사진 등록</label>
      <div class="photo-row">
        <input type="file" id="photos" name="photos" multiple />
        <span class="photo-hint">*최대 5장까지</span>
      </div>
      <div class="photo-preview-wrap">
        <div class="photo-box"></div>
        <div class="photo-box"></div>
        <div class="photo-box"></div>
        <div class="photo-box"></div>
        <div class="photo-box"></div>
      </div>
    </div>

    <div>
      <button type="submit" class="review-submit-btn">작성 완료</button>
    </div>
  </form>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const starBox = document.querySelector(".rvreg-stars");
    const ratingInput = document.getElementById("rating-input");

    if (starBox && ratingInput) {
      const stars = starBox.querySelectorAll(".star");

      stars.forEach((star, i) => {
        star.onmouseenter = () => {
          stars.forEach((s, j) => s.classList.toggle("filled", j <= i));
        };

        star.onclick = () => {
          const val = star.dataset.value;
          ratingInput.value = val;
          starBox.dataset.rating = val;
        };
      });

      starBox.onmouseleave = () => {
        const current = starBox.dataset.rating || 0;
        stars.forEach((s) =>
          s.classList.toggle(
            "filled",
            Number(s.dataset.value) <= Number(current)
          )
        );
      };
    }

    const fileInput = document.getElementById("photos");
    const photoBoxes = document.querySelectorAll(".photo-preview-wrap .photo-box");

    if (!fileInput || photoBoxes.length === 0) return;

    let selectedFiles = [];

    function syncInput() {
      const dt = new DataTransfer();
      selectedFiles.forEach((f) => dt.items.add(f));
      fileInput.files = dt.files;
    }

    function renderBoxes() {
      photoBoxes.forEach((box) => {
        box.innerHTML = "";
      });

      selectedFiles.forEach((file, index) => {
        const box = photoBoxes[index];
        if (!box) return;

        const url = URL.createObjectURL(file);
        const img = document.createElement("img");
        img.src = url;
        img.alt = file.name;
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "cover";
        img.onload = () => URL.revokeObjectURL(url);

        box.appendChild(img);
      });
    }

    fileInput.addEventListener("change", function () {
      const newFiles = Array.from(fileInput.files);
      let merged = selectedFiles.concat(newFiles);
      const maxCount = photoBoxes.length;
      if (merged.length > maxCount) {
        alert("사진은 최대 5장까지만 등록할 수 있습니다.");
        merged = merged.slice(0, maxCount);
      }

      selectedFiles = merged;
      syncInput();
      renderBoxes();
    });
    photoBoxes.forEach((box, index) => {
      box.addEventListener("click", function () {
        if (!selectedFiles[index]) return;
        if (!confirm("이 사진을 삭제할까요?")) return;

        selectedFiles.splice(index, 1);
        syncInput();
        renderBoxes();
      });
    });
  });
</script>


{% endblock section %}
